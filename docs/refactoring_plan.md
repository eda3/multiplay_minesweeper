# マルチプレイヤーマインスイーパー ECSリファクタリング計画

## プロジェクト概要

マルチプレイヤーマインスイーパーは、WebAssemblyを使用したリアルタイム協力型のマインスイーパーゲームです。
現在、Entity Component System (ECS) アーキテクチャを採用するためのリファクタリングを行っています。

## 現状分析

現在のプロジェクトは以下のディレクトリ構造を持ち、部分的にECSの概念を取り入れています：

```
src/
├── components/    # コンポーネント定義
├── entities/      # エンティティ定義
├── resources/     # リソース管理
├── systems/       # システム実装
├── board.rs       # ボードロジック
├── game_state.rs  # ゲーム状態管理
├── js_bindings.rs # JavaScript連携
├── lib.rs         # エントリーポイント
├── message_handler.rs  # 未使用
├── models.rs      # データモデル
├── network.rs     # ネットワーク処理
├── rendering.rs   # レンダリングロジック
└── utils.rs       # ユーティリティ
```

## リファクタリング目標

1. 完全なECSアーキテクチャへの移行
2. コードの可読性と保守性の向上
3. 拡張性の確保
4. パフォーマンスの最適化

## リファクタリング計画

### フェーズ1: 基本ECS構造の完成 🏗️

1. **エンティティマネージャーの強化**
   - IDジェネレーターの実装
   - エンティティ追加・削除機能の改善
   - クエリ機能の拡張
   - **担当者**: TBD
   - **期限**: TBD

2. **コンポーネント構造の標準化**
   - 共通トレイトの定義
   - シリアライズ/デシリアライズ対応
   - コンポーネント間の依存関係明確化
   - **担当者**: TBD
   - **期限**: TBD

3. **システムレジストリの最適化**
   - 実行順序の制御機能
   - システム依存関係の定義
   - パフォーマンス計測機能
   - **担当者**: TBD
   - **期限**: TBD

### フェーズ2: ゲームロジックのECS移行 🧩

4. **ゲーム状態をECSリソースへ変換**
   - `game_state.rs`からリソースへの移行
   - グローバル状態の分割
   - **担当者**: TBD
   - **期限**: TBD

5. **ボードロジックをシステムへ移行**
   - セル公開ロジックをシステム化
   - フラグトグルをシステム化
   - ボード生成をシステム化
   - **担当者**: TBD
   - **期限**: TBD

6. **入力処理のシステム分離**
   - マウス入力システムの完全分離
   - 入力イベントのECSイベントへの変換
   - **担当者**: TBD
   - **期限**: TBD

### フェーズ3: ネットワーク統合 🌐

7. **ネットワークコンポーネントの設計**
   - ネットワーク識別子コンポーネント
   - 同期フラグコンポーネント
   - **担当者**: TBD
   - **期限**: TBD

8. **ネットワークシステムの実装**
   - メッセージシリアライズ/デシリアライズ
   - ネットワークイベント処理
   - 状態同期システム
   - **担当者**: TBD
   - **期限**: TBD

9. **イベントシステムの導入**
   - イベントキュー実装
   - イベント購読機能
   - システム間通信の標準化
   - **担当者**: TBD
   - **期限**: TBD

### フェーズ4: レンダリング最適化 🎨

10. **レンダリングシステムのECS化**
    - 描画コンポーネント定義
    - レイヤー別レンダリングシステム
    - カメラシステム導入
    - **担当者**: TBD
    - **期限**: TBD

11. **UIコンポーネント設計**
    - UIエンティティの標準化
    - インタラクション処理
    - スタイリングシステム
    - **担当者**: TBD
    - **期限**: TBD

### フェーズ5: パフォーマンスと拡張性 🚀

12. **パフォーマンス最適化**
    - コンポーネントストレージ最適化
    - システム実行のスケジューリング改善
    - メモリ使用量削減
    - **担当者**: TBD
    - **期限**: TBD

13. **拡張機能の準備**
    - プラグインシステム導入
    - カスタムルール対応
    - アセット管理システム
    - **担当者**: TBD
    - **期限**: TBD

## 実装アプローチ

1. **単一の機能変更に集中する**
   - 一度に1つのコンポーネントまたはシステムをリファクタリング
   - 変更後すぐにテスト

2. **既存のテストを最大限活用**
   - テストを更新して新しいECS構造に対応
   - 結果が変わらないことを確認

3. **ブランチ戦略の活用**
   - 各フェーズごとにブランチを作成
   - プルリクエストでコードレビュー

4. **段階的な統合**
   - 各変更を独立してメインに統合
   - 問題があれば早期に対処

## 不要ファイルの削除

リファクタリングの一環として、以下の不要ファイルを削除予定：

- `src/message_handler.rs` - 未使用のメッセージハンドラモジュール
- `nohup.out` - バックグラウンド実行時の一時ログファイル

## 進捗管理

| タスク | 担当者 | 開始日 | 終了予定 | 状態 | 備考 |
|-------|-------|-------|---------|------|------|
| **フェーズ1: 基本ECS構造の完成** | | | | | |
| 1. エンティティマネージャーの強化 | | | | 未着手 | |
| 2. コンポーネント構造の標準化 | | | | 未着手 | |
| 3. システムレジストリの最適化 | | | | 未着手 | |
| **フェーズ2: ゲームロジックのECS移行** | | | | | |
| 4. ゲーム状態をECSリソースへ変換 | | | | 未着手 | |
| 5. ボードロジックをシステムへ移行 | | | | 未着手 | |
| 6. 入力処理のシステム分離 | | | | 未着手 | |
| **フェーズ3: ネットワーク統合** | | | | | |
| 7. ネットワークコンポーネントの設計 | | | | 未着手 | |
| 8. ネットワークシステムの実装 | | | | 未着手 | |
| 9. イベントシステムの導入 | | | | 未着手 | |
| **フェーズ4: レンダリング最適化** | | | | | |
| 10. レンダリングシステムのECS化 | | | | 未着手 | |
| 11. UIコンポーネント設計 | | | | 未着手 | |
| **フェーズ5: パフォーマンスと拡張性** | | | | | |
| 12. パフォーマンス最適化 | | | | 未着手 | |
| 13. 拡張機能の準備 | | | | 未着手 | |
| **追加タスク** | | | | | |
| 不要ファイルの削除 | | | | 未着手 | message_handler.rs, nohup.out |
| ドキュメント更新 | | | | 進行中 | |

## 技術的メモ

### ECSの基本概念

- **Entity**: 一意のIDを持つオブジェクト
- **Component**: データのみを持つ構造体
- **System**: コンポーネントを処理するロジック
- **Resource**: グローバルに共有されるデータ

### 依存ライブラリ

- web_sys 0.3.77
- js_sys 0.3.77
- wasm-bindgen 0.2
- serde 1.0 