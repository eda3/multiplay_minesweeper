<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
            flex-direction: column;
        }

        #game-canvas {
            border: 1px solid #444;
            background-color: #000;
            cursor: pointer;
            margin-top: 50px;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
        }

        #instructions {
            color: white;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        #server-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5261078090588815"
        crossorigin="anonymous"></script>
</head>

<body>
    <h1 style="color: white; margin-bottom: 10px;">ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼</h1>
    <canvas id="game-canvas" width="800" height="600"></canvas>
    <div id="info">
        <div id="connection-status">WebSocket: æ¥ç¶šä¸­...</div>
        <div id="player-count">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: 0</div>
        <div id="game-status">ã‚²ãƒ¼ãƒ é–‹å§‹å¾…ã¡...</div>
    </div>
    <div id="instructions">
        <p>å·¦ã‚¯ãƒªãƒƒã‚¯: ãƒã‚¹ã‚’é–‹ã | å³ã‚¯ãƒªãƒƒã‚¯: ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹/å–ã‚Šæ¶ˆã™</p>
        <p>ã¿ã‚“ãªã§å”åŠ›ã—ã¦åœ°é›·ã‚’é¿ã‘ã‚ˆã†ï¼</p>
        <p>é€”ä¸­ã‹ã‚‰å…¥ã£ã¦ããŸäººã¯çˆ†å¼¾ã®çŠ¶æ³ãŒåˆ†ã‹ã‚‰ãªã„ãƒã‚°ç™ºå£°ä¸­ï¼ˆãˆã ï¼‰</p>
    </div>
    <button id="server-button">ã‚µãƒ¼ãƒãƒ¼è¨­å®š</button>

    <script type="module">
        console.log('ğŸ” ã‚¹ã‚¯ãƒªãƒ—ãƒˆåˆæœŸåŒ–é–‹å§‹...');

        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function debug(category, message, data = null) {
            const timestamp = new Date().toISOString().substr(11, 8);
            const prefix = `[${timestamp}][${category}]`;

            if (data) {
                console.log(`${prefix} ${message}`, data);
            } else {
                console.log(`${prefix} ${message}`);
            }
        }

        debug('INIT', 'ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
        debug('ENV', `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${navigator.userAgent}`);
        debug('ENV', `ç”»é¢ã‚µã‚¤ã‚º: ${window.innerWidth}x${window.innerHeight}`);

        // WebSocketã‚µãƒ¼ãƒãƒ¼ã®URLè¨­å®š
        window.getWebSocketUrl = () => {
            debug('WS', 'WebSocketURLå–å¾—å‡¦ç†é–‹å§‹');

            // æ¬¡ã®ã„ãšã‚Œã‹ã®URLã‚’ä½¿ç”¨
            // 1. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æŒ‡å®šã•ã‚ŒãŸå ´åˆ (?server=wss://example.com)
            // 2. localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆ
            // 3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®é–‹ç™ºç’°å¢ƒ

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('server')) {
                const serverUrl = urlParams.get('server');
                debug('WS', `URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã‚’å–å¾—: ${serverUrl}`);
                // return serverUrl;
                return 'wss://multi-minesweeper.eda3.dev:8443';
            }

            const savedServer = localStorage.getItem('minesweeper_server');
            if (savedServer) {
                debug('WS', `LocalStorageã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã‚’å–å¾—: ${savedServer}`);
                // return savedServer;
                return 'wss://multi-minesweeper.eda3.dev:8443';
            }

            debug('WS', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨: ws://localhost:8080');
            // return 'wss://162.43.8.148:8080';
            return 'wss://multi-minesweeper.eda3.dev:8443';
        };

        // ã‚µãƒ¼ãƒãƒ¼è¨­å®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        document.getElementById('server-button').addEventListener('click', () => {
            debug('UI', 'ã‚µãƒ¼ãƒãƒ¼è¨­å®šãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');

            const currentServer = getWebSocketUrl();
            debug('UI', `ç¾åœ¨ã®ã‚µãƒ¼ãƒãƒ¼URL: ${currentServer}`);

            const newServer = prompt('ã‚µãƒ¼ãƒãƒ¼ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentServer);
            debug('UI', `å…¥åŠ›ã•ã‚ŒãŸæ–°ã—ã„ã‚µãƒ¼ãƒãƒ¼URL: ${newServer}`);

            if (newServer && newServer.trim() !== '') {
                debug('UI', `æ–°ã—ã„ã‚µãƒ¼ãƒãƒ¼URLã‚’ä¿å­˜: ${newServer.trim()}`);
                localStorage.setItem('minesweeper_server', newServer.trim());
                alert('ã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
                debug('UI', 'ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™...');
                window.location.reload();
            } else {
                debug('UI', 'ã‚µãƒ¼ãƒãƒ¼URLå…¥åŠ›ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
            }
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªé–¢æ•°å®šç¾©ï¼ˆRustã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
        window.updateConnectionStatus = (connected) => {
            debug('STATUS', `WebSocketæ¥ç¶šçŠ¶æ…‹ã®æ›´æ–°: ${connected ? 'æ¥ç¶šä¸­' : 'æœªæ¥ç¶š'}`);

            const status = document.getElementById('connection-status');
            status.textContent = `WebSocket: ${connected ? 'æ¥ç¶šä¸­' : 'æœªæ¥ç¶š'}`;
            status.style.color = connected ? '#8F8' : '#F88';
        };

        window.updatePlayerCount = (count) => {
            debug('STATUS', `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã®æ›´æ–°: ${count}äºº`);

            const playerCount = document.getElementById('player-count');
            playerCount.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${count}`;
        };

        window.updateGameStatus = (status) => {
            debug('GAME', `ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®æ›´æ–°: ${status}`);

            const gameStatus = document.getElementById('game-status');
            gameStatus.textContent = status;

            if (status.includes('å‹åˆ©')) {
                debug('GAME', 'ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼');
                gameStatus.style.color = '#8F8';
            } else if (status.includes('ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼')) {
                debug('GAME', 'ğŸ’¥ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼...');
                gameStatus.style.color = '#F88';
            } else {
                gameStatus.style.color = 'white';
            }
        };

        // WASMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        debug('WASM', 'WASMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹');
        import init from './pkg/wasm_multiplayer.js';

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨é–¢æ•°
        window.addEventListener('error', (event) => {
            debug('ERROR', `ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${event.message}`, {
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
        });

        async function start() {
            debug('STARTUP', 'ã‚²ãƒ¼ãƒ èµ·å‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é–‹å§‹');

            try {
                debug('WASM', 'WASMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–é–‹å§‹');
                // WASMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–
                const wasm = await init();
                debug('WASM', 'WASMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†ï¼');

                // Canvasã‚’å–å¾—
                const canvas = document.getElementById('game-canvas');
                debug('UI', `Canvaså–å¾—: ${canvas.width}x${canvas.height}`);

                // ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
                debug('GAME', 'start_gameé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™');
                wasm.start_game(canvas);

                debug('GAME', 'ğŸ® ã‚²ãƒ¼ãƒ èµ·å‹•æˆåŠŸï¼');
                console.log("Game started successfully!");
            } catch (error) {
                debug('ERROR', 'âš ï¸ ã‚²ãƒ¼ãƒ èµ·å‹•ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error);
                console.error("Error starting game:", error);

                // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤º
                const errorMessage = document.createElement('div');
                errorMessage.style.color = 'red';
                errorMessage.style.backgroundColor = 'rgba(0,0,0,0.7)';
                errorMessage.style.padding = '20px';
                errorMessage.style.margin = '20px';
                errorMessage.style.borderRadius = '5px';
                errorMessage.innerHTML = `
                    <h3>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
                    <p>${error.message}</p>
                    <p>è©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
                `;
                document.body.appendChild(errorMessage);
            }
        }

        // é–‹å§‹å‡¦ç†
        debug('STARTUP', 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•');
        start();
        debug('STARTUP', 'èµ·å‹•å‡¦ç†å®Œäº†');
    </script>
</body>

</html>