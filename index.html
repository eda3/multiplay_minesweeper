<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マルチプレイヤー・マインスイーパー</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
            flex-direction: column;
        }
        #game-canvas {
            border: 1px solid #444;
            background-color: #000;
            cursor: pointer;
            margin-top: 50px;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
        }
        #instructions {
            color: white;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        #server-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1 style="color: white; margin-bottom: 10px;">マルチプレイヤー・マインスイーパー</h1>
    <canvas id="game-canvas" width="800" height="600"></canvas>
    <div id="info">
        <div id="connection-status">WebSocket: 接続中...</div>
        <div id="player-count">プレイヤー数: 0</div>
        <div id="game-status">ゲーム開始待ち...</div>
    </div>
    <div id="instructions">
        <p>左クリック: マスを開く | 右クリック: フラグを立てる/取り消す</p>
        <p>みんなで協力して地雷を避けよう！</p>
    </div>
    <button id="server-button">サーバー設定</button>

    <script type="module">
        // WebSocketサーバーのURL設定
        window.getWebSocketUrl = () => {
            // 次のいずれかのURLを使用
            // 1. URLパラメータから指定された場合 (?server=wss://example.com)
            // 2. localStorageに保存されている場合
            // 3. デフォルトはローカルの開発環境
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('server')) {
                return urlParams.get('server');
            }
            
            const savedServer = localStorage.getItem('minesweeper_server');
            if (savedServer) {
                return savedServer;
            }
            
            return 'ws://localhost:8080';
        };
        
        // サーバー設定ボタンのイベント設定
        document.getElementById('server-button').addEventListener('click', () => {
            const currentServer = getWebSocketUrl();
            const newServer = prompt('サーバーのURLを入力してください:', currentServer);
            
            if (newServer && newServer.trim() !== '') {
                localStorage.setItem('minesweeper_server', newServer.trim());
                alert('サーバー設定を保存しました。ページを再読み込みします。');
                window.location.reload();
            }
        });

        // グローバルな関数定義（Rustから呼び出せるようにする）
        window.updateConnectionStatus = (connected) => {
            const status = document.getElementById('connection-status');
            status.textContent = `WebSocket: ${connected ? '接続中' : '未接続'}`;
            status.style.color = connected ? '#8F8' : '#F88';
        };
        
        window.updatePlayerCount = (count) => {
            const playerCount = document.getElementById('player-count');
            playerCount.textContent = `プレイヤー数: ${count}`;
        };
        
        window.updateGameStatus = (status) => {
            const gameStatus = document.getElementById('game-status');
            gameStatus.textContent = status;
            
            if (status.includes('勝利')) {
                gameStatus.style.color = '#8F8';
            } else if (status.includes('ゲームオーバー')) {
                gameStatus.style.color = '#F88';
            } else {
                gameStatus.style.color = 'white';
            }
        };

        // WASMモジュールをインポート
        import init from './pkg/wasm_multiplayer.js';

        async function start() {
            try {
                // WASMモジュールを初期化
                const wasm = await init();
                
                // Canvasを取得
                const canvas = document.getElementById('game-canvas');
                
                // ゲームを開始
                wasm.start_game(canvas);
                
                console.log("Game started successfully!");
            } catch (error) {
                console.error("Error starting game:", error);
            }
        }

        start();
    </script>
</body>
</html>
